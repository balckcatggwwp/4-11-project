<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control"
	content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>æœƒå“¡ç®¡ç† - å…‰å½±ä¹‹é–€</title>

<link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet"
	type="text/css">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link href="/css/sb-admin-2.min.css" rel="stylesheet">
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
	rel="stylesheet">
<link
	href="https://cdn.datatables.net/2.2.2/css/dataTables.bootstrap5.min.css"
	rel="stylesheet">
<link
	href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
	rel="stylesheet">

</head>
<body id="page-top">
	<div id="wrapper">
		<th:block th:replace="fragments/empSidebar :: sidebar"></th:block>
		<div id="content-wrapper" class="d-flex flex-column">
			<div id="content">
				<th:block th:replace="fragments/empTopbar :: topbar"></th:block>

				<div class="container-fluid mt-4">
					<div
						class="d-sm-flex align-items-center justify-content-between mb-4">
						<h1 class="h4 text-gray-800">æœƒå“¡ç®¡ç†ç³»çµ±</h1>
						<div class="d-flex gap-2">
							<button class="btn btn-success" data-bs-toggle="modal"
								data-bs-target="#registerModal">
								<i class="fas fa-user-plus"></i> æ–°å¢æœƒå“¡
							</button>
							<a class="btn btn-success" href="/member/memberStats"> <i class="fas fa-user-plus"></i>
								æœƒå“¡çµ±è¨ˆè³‡æ–™
							</a>
						</div>
					</div>

					<div class="card mb-4">
						<div class="card-body">
							<div class="row mb-3">
								<div class="col-md-3">
									<select id="searchType" class="form-select">
										<option value="" selected>è«‹é¸æ“‡æœå°‹çš„åŠŸèƒ½</option>
										<option value="name">å§“åæ¨¡ç³Šæœå°‹</option>
										<option value="email">ä¿¡ç®±æ¨¡ç³Šæœå°‹</option>
										<option value="phone">æ‰‹æ©Ÿè™Ÿç¢¼æ¨¡ç³Šæœå°‹</option>
									</select>
								</div>
								<div class="col-md-5">
									<input type="text" id="keyword" class="form-control"
										placeholder="è«‹è¼¸å…¥é—œéµå­—">
								</div>
								<div class="col-md-2">
									<button class="btn btn-primary" id="searchBtn">æœå°‹</button>
								</div>
							</div>
							<div class="table-responsive">
								<table id="memberTable"
									class="table table-bordered table-striped">
									<thead class="table-light">
										<tr>
											<th>æœƒå“¡ID</th>
											<th>å§“å</th>
											<th>æ€§åˆ¥</th>
											<th>é›»å­ä¿¡ç®±</th>
											<th>æ‰‹æ©Ÿè™Ÿç¢¼</th>
											<th>è¨»å†Šæ™‚é–“</th>
											<th>æ“ä½œ</th>
										</tr>
									</thead>
									<tbody></tbody>
								</table>
							</div>
						</div>
					</div>
				</div>

			</div>
			<th:block th:replace="fragments/empFooter :: footer"></th:block>
		</div>
	</div>

	<a class="scroll-to-top rounded" href="#page-top"><i
		class="fas fa-angle-up"></i></a>
	<th:block th:replace="member/memberModalCRUD :: viewModal"></th:block>
	<th:block th:replace="member/memberModalCRUD :: registerModal"></th:block>
	<th:block th:replace="member/memberModalCRUD :: editModal"></th:block>

	<script
		src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
	<script
		src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.min.js"></script>
	<script src="/js/sb-admin-2.min.js"></script>
	<script src="/js/empTobar.js"></script>
	<script src="/js/empLogout.js"></script>
	<script src="/js/checkEmpSession.js"></script>

	<script>
		$(function () {
		  const table = $('#memberTable').DataTable({
		    ajax: {
		      url: '/memberAPI/memberListEmp',
		      dataSrc: '',
		      error: function(xhr, error, thrown) {
		        console.log('DataTables AJAX error:', xhr.responseText);
		        Swal.fire('è®€å–è³‡æ–™å¤±æ•—', 'è«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥API', 'error');
		      }
		    },
		    columns: [
		      { data: 'memberId' },
		      { data: 'name' },
		      { data: 'gender' },
		      { data: 'email' },
		      { data: 'phoneNumber' },
		      { data: 'createTime' },
		      {
		        data: null,
		        orderable: false,
		        searchable: false,
		        render: function(data, type, row) {
		          return `
		            <button class="btn btn-info btn-sm me-1 viewBtn" data-id="${row.memberId}"><i class="fas fa-eye"></i> è©³ç´°</button>
		            <button class="btn btn-warning btn-sm me-1 editBtn" data-id="${row.memberId}"><i class="fas fa-edit"></i> ä¿®æ”¹</button>
		            <button class="btn btn-danger btn-sm deleteBtn" data-id="${row.memberId}"><i class="fas fa-trash"></i> åˆªé™¤</button>
		          `;
		        }
		      }
		    ],
		    columnDefs: [
		      { targets: '_all', className: 'text-left' }
		    ],
		    language: {
		      url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json'
		    }
		  });
		
		  // æœå°‹åŠŸèƒ½
		  $('#searchBtn').click(function () {
		    const searchType = $('#searchType').val();
		    const keyword = $('#keyword').val().trim();
		
		    if (!searchType || !keyword) {
		      Swal.fire('è«‹é¸æ“‡æœå°‹é¡å‹ä¸¦è¼¸å…¥é—œéµå­—ï¼');
		      return;
		    }
		
		    let columnIndex;
		    if (searchType === 'name') columnIndex = 1;
		    else if (searchType === 'email') columnIndex = 3;
		    else if (searchType === 'phone') columnIndex = 4;
		
		    table.column(columnIndex).search(keyword).draw();
		  });
		
		});

	</script>
	<script>
	$('#memberTable tbody').on('click', '.deleteBtn', function () {
	    const memberId = $(this).data('id');
	
	    Swal.fire({
	        title: 'ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ',
	        text: 'åˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ï¼',
	        icon: 'warning',
	        showCancelButton: true,
	        confirmButtonColor: '#d33',
	        cancelButtonColor: '#3085d6',
	        confirmButtonText: 'ç¢ºå®šåˆªé™¤'
	    }).then((result) => {
	        if (result.isConfirmed) {
	            $.ajax({
	                url: `/memberAPI/deleteMember/${memberId}`,
	                method: 'DELETE',
	                success: function (response) {
	                    if (response.status === 'success') {
	                        Swal.fire('åˆªé™¤æˆåŠŸï¼', response.message, 'success').then(() => {
	                            $('#memberTable').DataTable().ajax.reload(); // åˆ·æ–°è¡¨æ ¼
	                        });
	                    } else {
	                        Swal.fire('åˆªé™¤å¤±æ•—', response.message || 'è«‹ç¨å¾Œå†è©¦', 'error');
	                    }
	                },
	                error: function (xhr) {
	                    console.log('åˆªé™¤æœƒå“¡å¤±æ•—', xhr.responseText);
	                    Swal.fire('éŒ¯èª¤', 'ä¼ºæœå™¨éŒ¯èª¤æˆ–è³‡æ–™ç¶å®šç„¡æ³•åˆªé™¤', 'error');
	                }
	            });
	        }
	    });
	});
	
	</script>
	<script>
		$('#memberTable tbody').on('click', '.editBtn', function () {
		  const memberId = $(this).data('id');
		
		  // å…ˆæ‰“ API å–å¾—é€™å€‹æœƒå“¡è©³ç´°è³‡æ–™
		  $.ajax({
		    url: `/memberAPI/memberDetial/${memberId}`,
		    method: 'GET',
		    success: function (data) {
		      console.log('è¼‰å…¥æœƒå“¡è³‡æ–™', data);
		      // æŠŠè³‡æ–™å¡åˆ° modal çš„ input è£¡
		      $('#edit-form [name="memberId"]').val(data.memberId);
		      $('#edit-form [name="name"]').val(data.name);
		      $('#edit-form [name="email"]').val(data.email);
		      $('#edit-form [name="phoneNumber"]').val(data.phoneNumber);
		      $('#edit-form [name="dateOfBirth"]').val(data.dateOfBirth);
		      
		      // æ€§åˆ¥ radio button é¸å–
		      $('#edit-form [name="gender"]').each(function () {
		        if ($(this).val() === data.gender) {
		          $(this).prop('checked', true);
		        }
		      });
		
		      // æ‰“é–‹ modal
		      $('#editModal').modal('show');
		    },
		    error: function (xhr) {
		      console.log('å–å¾—æœƒå“¡è³‡æ–™å¤±æ•—', xhr.responseText);
		      Swal.fire('éŒ¯èª¤', 'å–å¾—æœƒå“¡è³‡æ–™å¤±æ•—', 'error');
		    }
		  });
		});
		
		</script>
	<script>
		$('#edit-form').submit(function (e) {
		  e.preventDefault();
		
		  const formData = {
		    memberId: $('#edit-form [name="memberId"]').val(),
		    name: $('#edit-form [name="name"]').val(),
		    gender: $('#edit-form [name="gender"]:checked').val(),
		    email: $('#edit-form [name="email"]').val(),
		    phoneNumber: $('#edit-form [name="phoneNumber"]').val(),
		    dateOfBirth: $('#edit-form [name="dateOfBirth"]').val()
		  };
		
		  console.log('é€å‡ºä¿®æ”¹è³‡æ–™', formData);
		
		  $.ajax({
		    url: '/memberAPI/updateProfileByEmp',  // ğŸ‘‰ (ç­‰ç­‰æœƒè£œé€™æ”¯å¾Œç«¯)
		    method: 'POST',
		    data: formData,
		    success: function (response) {
		      if (response.status === 'success') {
		        Swal.fire('æ›´æ–°æˆåŠŸï¼', '', 'success');
		        $('#editModal').modal('hide');
		        $('#memberTable').DataTable().ajax.reload();
		      } else {
		        Swal.fire('æ›´æ–°å¤±æ•—', response.message, 'error');
		      }
		    },
		    error: function (xhr) {
		      console.log('æ›´æ–°å¤±æ•—', xhr.responseText);
		      Swal.fire('éŒ¯èª¤', 'æ›´æ–°è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
		    }
		  });
		});
		
		</script>
	<script>
		$(function () {
		  $('#memberTable tbody').on('click', '.viewBtn', function () {
		    const memberId = $(this).data('id');
		
		    $.ajax({
		      url: `/memberAPI/memberDetailByEmp/${memberId}`,  // âš¡ æ”¹æˆæ–°çš„APIï¼ˆæœƒåŒ…å«å®Œæ•´è³‡è¨Šï¼‰
		      method: 'GET',
		      success: function (data) {
		        if (data.status === 'success') {
		          $('#view-memberId').text(data.memberId || 'ç„¡');
		          $('#view-name').text(data.name || 'ç„¡');
		          $('#view-gender').text(
		            data.gender === 'male' ? 'ç”·' :
		            data.gender === 'female' ? 'å¥³' :
		            data.gender === 'other' ? 'ä¸é¡˜é€éœ²' :
		            '-'
		          );
		          $('#view-dateOfBirth').text(data.dateOfBirth || 'ç„¡');
		          $('#view-nationalId').text(data.nationalId || 'ç„¡');
		          $('#view-email').text(data.email || 'ç„¡');
		          $('#view-phoneNumber').text(data.phoneNumber || 'ç„¡');
		          $('#view-newEmail').text(data.newEmail || 'ç„¡');
		          $('#view-verification').html(
		            data.verification
		              ? '<span class="badge bg-success">å·²é©—è­‰</span>'
		              : '<span class="badge bg-danger">æœªé©—è­‰</span>'
		          );
		          $('#view-createTime').text(data.createTime || 'ç„¡');
		          $('#view-memberType').text(data.memberType || 'ç„¡');
		
		          $('#viewModal').modal('show');
		        } else {
		          Swal.fire('éŒ¯èª¤', data.message, 'error');
		        }
		      },
		      error: function (xhr) {
		        console.log('å–å¾—æœƒå“¡è©³ç´°å¤±æ•—', xhr.responseText);
		        Swal.fire('éŒ¯èª¤', 'å–å¾—è©³ç´°è³‡æ–™å¤±æ•—', 'error');
		      }
		    });
		  });
		});	
		</script>
	<script>
		$(function () {
		  // æ‰“é–‹Modalæ™‚ï¼Œè¼‰å…¥æœƒå“¡èº«ä»½é¸å–®
		  $('#registerModal').on('show.bs.modal', function () {
		    $.ajax({
		      url: '/memberAPI/memberTypes',
		      method: 'GET',
		      success: function (data) {
		        const $memberTypeSelect = $('#memberTypeId');
		        $memberTypeSelect.empty();
		        $memberTypeSelect.append('<option value="">è«‹é¸æ“‡æœƒå“¡èº«ä»½</option>');
		        data.forEach(function (type) {
		          $memberTypeSelect.append(`<option value="${type.id}">${type.name}</option>`);
		        });
		      },
		      error: function (xhr) {
		        console.log('å–å¾—æœƒå“¡èº«ä»½å¤±æ•—', xhr.responseText);
		        Swal.fire('éŒ¯èª¤', 'å–å¾—æœƒå“¡èº«ä»½é¸å–®å¤±æ•—', 'error');
		      }
		    });
		  });
		
		  // æäº¤è¡¨å–®é€å‡ºæ–°å¢
		  $('#register-form').submit(function (e) {
		    e.preventDefault();
		
		    const formData = {
		      name: $('#register-form [name="name"]').val(),
		      gender: $('#register-form [name="gender"]:checked').val(),
		      email: $('#register-form [name="email"]').val(),
		      phoneNumber: $('#register-form [name="phoneNumber"]').val(),
		      dateOfBirth: $('#register-form [name="dateOfBirth"]').val(),
		      nationalId: $('#register-form [name="nationalId"]').val(),
		      memberTypeId: $('#register-form [name="memberTypeId"]').val()
		    };
		
		    $.ajax({
		      url: '/memberAPI/registerByEmp',
		      method: 'POST',
		      data: formData,
		      success: function (response) {
		        if (response.status === 'success') {
		          Swal.fire('æ–°å¢æˆåŠŸ', response.message, 'success');
		          $('#registerModal').modal('hide');
		          $('#memberTable').DataTable().ajax.reload(); // æ–°å¢æˆåŠŸå¾Œåˆ·æ–°è¡¨æ ¼
		        } else {
		          Swal.fire('éŒ¯èª¤', response.message, 'error');
		        }
		      },
		      error: function (xhr) {
		        console.log('æ–°å¢æœƒå“¡å¤±æ•—', xhr.responseText);
		        Swal.fire('éŒ¯èª¤', 'æ–°å¢æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
		      }
		    });
		  });
		});
		
		// å·¥å…·ï¼šéš¨æ©Ÿè‹±æ–‡åç¨±
		function getRandomName() {
		  const names = ["å°æ˜", "å°è¯", "è‰¾è‰", "John", "Emma", "é˜¿å‰", "é˜¿ç"];
		  return names[Math.floor(Math.random() * names.length)];
		}
		
		// å·¥å…·ï¼šéš¨æ©Ÿæ€§åˆ¥
		function getRandomGender() {
		  const gender = ["male", "female", "other"];
		  return gender[Math.floor(Math.random() * gender.length)];
		}
		
		// å·¥å…·ï¼šéš¨æ©Ÿèº«åˆ†è­‰è™Ÿç¢¼ (ç°¡åŒ–ç¯„ä¾‹ï¼Œéåš´æ ¼é©—è­‰)
		function getRandomId() {
		  const head = String.fromCharCode(65 + Math.floor(Math.random() * 26));
		  return head + (Math.random() < 0.5 ? "1" : "2") + Math.floor(10000000 + Math.random() * 90000000);
		}
		
		// å·¥å…·ï¼šéš¨æ©Ÿæ‰‹æ©Ÿè™Ÿç¢¼
		function getRandomPhone() {
		  return "09" + Math.floor(100000000 + Math.random() * 90000000).toString().substring(1);
		}
		
		// å·¥å…·ï¼šéš¨æ©Ÿ email
		function getRandomEmail() {
		  const prefix = "test" + Math.floor(Math.random() * 100000);
		  return prefix + "@example.com";
		}
		
		// æ ¸å¿ƒåŠŸèƒ½ï¼šè‡ªå‹•å¡«å…¥ä¸é‡è¤‡çš„æœƒå“¡è³‡æ–™
		$('#autoFillMemberBtn').click(async function () {
		  const maxAttempts = 10;
		  let attempt = 0;
		  let email, phoneNumber;
		
		  while (attempt < maxAttempts) {
		    email = getRandomEmail();
		    phoneNumber = getRandomPhone();
		
		    const exists = await $.ajax({
		      url: '/memberAPI/checkEmailPhone',
		      method: 'POST',
		      contentType: 'application/json',
		      data: JSON.stringify({ email, phoneNumber })
		    });
		
		    if (!exists.duplicated) break; // é€šéé©—è­‰
		    attempt++;
		  }
		
		  if (attempt >= maxAttempts) {
		    Swal.fire('éŒ¯èª¤', 'ç„¡æ³•ç”¢ç”Ÿå”¯ä¸€çš„ä¿¡ç®±èˆ‡æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
		    return;
		  }
		
		  // æˆåŠŸç”¢ç”Ÿå¾Œå¡«å…¥
		  $('input[name="name"]').val(getRandomName());
		  $('input[name="gender"][value="' + getRandomGender() + '"]').prop("checked", true);
		  $('input[name="email"]').val(email);
		  $('input[name="phoneNumber"]').val(phoneNumber);
		  $('input[name="dateOfBirth"]').val("1990-01-01");
		  $('input[name="nationalId"]').val(getRandomId());
		  $('#memberTypeId').val($('#memberTypeId option:eq(1)').val()); // é è¨­é¸ç¬¬ä¸€å€‹æœ‰æ•ˆèº«ä»½
		});
		$('#batchInsertBtn').click(async function () {
			  const count = parseInt($('#batchCount').val(), 10);
			  if (isNaN(count) || count <= 0 || count > 20) {
			    Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥ 1~20 çš„æ•¸å­—', 'warning');
			    return;
			  }
			
			  const created = [];
			
			  for (let i = 0; i < count; i++) {
			    let email, phoneNumber, tryCount = 0;
			    const maxTry = 10;
			
			    // å˜—è©¦ç”¢ç”Ÿä¸é‡è¤‡çš„ email / phone
			    while (tryCount < maxTry) {
			      email = getRandomEmail();
			      phoneNumber = getRandomPhone();
			
			      const exists = await $.ajax({
			        url: '/memberAPI/checkEmailPhone',
			        method: 'POST',
			        contentType: 'application/json',
			        data: JSON.stringify({ email, phoneNumber })
			      });
			
			      if (!exists.duplicated) break;
			      tryCount++;
			    }
			
			    if (tryCount >= maxTry) {
			      console.warn(`ç¬¬ ${i + 1} ç­†æ”¾æ£„ï¼šç”¢ç”Ÿå”¯ä¸€ä¿¡ç®±å¤±æ•—`);
			      continue;
			    }
			
			    // é€å‡ºä¸€ç­†æ–°å¢è«‹æ±‚
			    const payload = {
			      name: getRandomName(),
			      gender: getRandomGender(),
			      email: email,
			      phoneNumber: phoneNumber,
			      dateOfBirth: "1990-01-01",
			      nationalId: getRandomId(),
			      memberTypeId: $('#memberTypeId option:eq(1)').val()
			    };
			
			    try {
			      const res = await $.ajax({
			        url: '/memberAPI/registerByEmp',
			        method: 'POST',
			        data: payload
			      });
			
			      if (res.status === 'success') {
			        created.push(payload.email);
			      }
			    } catch (err) {
			      console.warn(`ç¬¬ ${i + 1} ç­†éŒ¯èª¤`, err.responseText);
			    }
			  }
			
			  Swal.fire(`å®Œæˆ ${created.length} ç­†æ–°å¢`, `Emailï¼š<br>${created.join('<br>')}`, 'success');
			  $('#memberTable').DataTable().ajax.reload();
			});
		</script>
</body>
</html>