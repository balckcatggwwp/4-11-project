<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>員工職稱與權限管理</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
<link href="/css/sb-admin-2.min.css" rel="stylesheet">
</head>

<body id="page-top">
<div id="wrapper">

	<!-- Sidebar -->
	<ul th:replace="fragments/EmpSidebar :: sidebar"></ul>
	<!-- End of Sidebar -->

	<!-- Content Wrapper -->
	<div id="content-wrapper" class="d-flex flex-column">

		<!-- Main Content -->
		<div id="content">

			<!-- Topbar -->
			<nav th:replace="fragments/empTopbar :: topbar"></nav>

			<!-- Begin Page Content -->
			<div class="container-fluid">
				<h1 class="h3 mb-4 text-gray-800">員工權限管理</h1>

				<!-- 權限管理清單 -->
				<div class="card mb-4">
					<div class="card-header py-3">
						<h6 class="m-0 font-weight-bold text-primary">管理下屬員工</h6>
					</div>
					<div class="card-body">
						<table class="table table-bordered" id="subordinateTable">
							<thead>
								<tr>
									<th>姓名</th>
									<th>職稱</th>
									<th>職位等級</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>

				<!-- 員工註冊表單 -->
				<div class="card mb-4">
					<div class="card-header py-3">
						<h6 class="m-0 font-weight-bold text-primary">員工註冊</h6>
					</div>
					<div class="card-body">
						<form id="registerEmployeeForm" class="row g-3">
							<div class="col-md-6">
								<label for="name" class="form-label">姓名</label>
								<input type="text" class="form-control" id="name" name="name" required>
							</div>
							<div class="col-md-6">
								<label for="email" class="form-label">Email</label>
								<input type="email" class="form-control" id="email" name="email" required>
							</div>
							<div class="col-md-6">
								<label for="phoneNumber" class="form-label">手機號碼</label>
								<input type="text" class="form-control" id="phoneNumber" name="phoneNumber" maxlength="10" required>
							</div>
							<div class="col-md-6">
								<label for="jobTitleCategory" class="form-label">選擇職務</label>
								<select id="jobTitleCategory" name="jobTitleCategoryId" class="form-select" required>
									<option value="">請選擇</option>
								</select>
							</div>
							<div class="col-12">
								<button type="submit" class="btn btn-primary">註冊員工</button>
							</div>
						</form>
					</div>
				</div>

			</div>

		</div>

		<!-- Footer -->
		<footer th:replace="fragments/empFooter :: footer"></footer>

	</div>

</div>

<a class="scroll-to-top rounded" href="#page-top">
	<i class="fas fa-angle-up"></i>
</a>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/sb-admin-2.min.js"></script>

<script>
$(function() {
	// 載入下屬員工列表
	$.ajax({
		url: '/employeeApi/subordinates',
		method: 'GET',
		success: function (data) {
			const tbody = $('#subordinateTable tbody');
			tbody.empty();
			data.forEach(emp => {
				tbody.append(`
					<tr>
						<td>${emp.name}</td>
						<td>${emp.jobTitleCategory.jobTitleName}</td>
						<td>${emp.jobTitleCategory.jobLevel}</td>
						<td>
							<button class="btn btn-warning btn-sm editBtn" data-id="${emp.empId}">修改</button>
							<button class="btn btn-danger btn-sm deleteBtn" data-id="${emp.empId}">刪除</button>
						</td>
					</tr>
				`);
			});
		},
		error: function () {
			alert('讀取下屬員工失敗');
		}
	});

	// 載入職稱下拉選單
	$.ajax({
		url: '/jobTitleApi/listByLoginUser',
		method: 'GET',
		success: function (data) {
			const select = $('#jobTitleCategory');
			select.empty();
			select.append('<option value="">請選擇</option>');
			data.forEach(j => {
				select.append(`<option value="${j.jobTitleCategoryId}">${j.jobTitleName} (等級${j.jobLevel})</option>`);
			});
		},
		error: function () {
			alert('讀取職稱失敗');
		}
	});

	// 提交註冊表單
	$('#registerEmployeeForm').submit(function (e) {
		e.preventDefault();

		const formData = {
			name: $('#name').val(),
			email: $('#email').val(),
			phoneNumber: $('#phoneNumber').val(),
			jobTitleCategoryId: $('#jobTitleCategory').val()
		};

		$.ajax({
			url: '/employeeApi/registerByEmp',
			method: 'POST',
			contentType: 'application/json',
			data: JSON.stringify(formData),
			success: function (res) {
				alert('註冊成功！');
				location.reload();
			},
			error: function () {
				alert('註冊失敗');
			}
		});
	});
	$(function() {
	// 開啟新增員工Modal時載入職稱和權限
	$('#addEmployeeModal').on('show.bs.modal', function() {
		// 載入職稱
		$.ajax({
			url: '/jobTitleApi/listByLoginUser',
			method: 'GET',
			success: function(data) {
				const $jobSelect = $('#jobTitleSelect');
				$jobSelect.empty();
				$jobSelect.append('<option value="">請選擇職稱</option>');
				data.forEach(job => {
					$jobSelect.append(`<option value="${job.jobTitleCategoryId}">${job.jobTitleName} (等級${job.jobLevel})</option>`);
				});
			},
			error: function() {
				Swal.fire('錯誤', '職稱資料讀取失敗', 'error');
			}
		});

		// 載入權限
		$.ajax({
			url: '/empPermissionApi/list',
			method: 'GET',
			success: function(data) {
				const $permContainer = $('#permissionsCheckboxes');
				$permContainer.empty();
				data.forEach(perm => {
					$permContainer.append(`
	                    <div class="form-check col-4">
	                        <input class="form-check-input" type="checkbox" value="${perm.empPermissionTypeId}" id="perm${perm.empPermissionTypeId}" name="permissions">
	                        <label class="form-check-label" for="perm${perm.empPermissionTypeId}">
	                            ${perm.empPermissionTypeName}
	                        </label>
	                    </div>
	                `);
				});
			},
			error: function() {
				Swal.fire('錯誤', '權限資料讀取失敗', 'error');
			}
		});
	});

	$('#addEmployeeForm').submit(function(e) {
		e.preventDefault();

		const password = $('#password').val();
		const password2 = $('#password2').val();

		if (password !== password2) {
			Swal.fire('密碼錯誤', '兩次輸入的密碼不一致', 'warning');
			return;
		}

		const selectedPermissions = [];
		$('input[name="permissions"]:checked').each(function() {
			selectedPermissions.push($(this).val());
		});

		const formData = {
			name: $('input[name="name"]').val(),
			gender: $('input[name="gender"]:checked').val(),
			nationalId: $('input[name="nationalId"]').val(),
			dateOfBirth: $('input[name="dateOfBirth"]').val(),
			entryTime: $('input[name="entryTime"]').val(),
			email: $('input[name="email"]').val(),
			phoneNumber: $('input[name="phoneNumber"]').val(),
			password: password,
			jobTitleCategoryId: $('#jobTitleSelect').val(),
			permissionIds: selectedPermissions
		};

		$.ajax({
			url: '/employeeApi/empRegister',
			method: 'POST',
			contentType: 'application/json',
			data: JSON.stringify(formData),
			success: function(res) {
				if (res.status === 'success') {
					Swal.fire('新增成功', '', 'success').then(() => {
						$('#addEmployeeModal').modal('hide');
						$('#employeeTable').DataTable().ajax.reload();
					});
				} else {
					Swal.fire('錯誤', res.message || '新增失敗', 'error');
				}
			},
			error: function() {
				Swal.fire('伺服器錯誤', '請稍後再試', 'error');
			}
		});
	});

});
// 開啟新增員工 Modal 時，載入職稱選單 & 權限勾選
$('#addEmployeeModal').on('show.bs.modal', function () {
    // 載入職稱
    $.ajax({
        url: '/jobTitleApi/listByLoginUser',
        method: 'GET',
        success: function (data) {
            const $jobSelect = $('#jobTitleSelect');
            $jobSelect.empty();
            $jobSelect.append('<option value="">請選擇職稱</option>');
            data.forEach(function (job) {
                $jobSelect.append(`<option value="${job.jobTitleCategoryId}">${job.jobTitleName} (等級${job.jobLevel})</option>`);
            });
        },
        error: function () {
            Swal.fire('錯誤', '職稱資料讀取失敗，請稍後再試', 'error');
        }
    });

    // 載入權限
    $.ajax({
        url: '/empPermissionApi/list',
        method: 'GET',
        success: function (data) {
            const $permContainer = $('#permissionsCheckboxes');
            $permContainer.empty();
            data.forEach(function (perm) {
                $permContainer.append(`
                    <div class="form-check col-4">
                        <input class="form-check-input" type="checkbox" value="${perm.empPermissionTypeId}" id="perm${perm.empPermissionTypeId}" name="permissions">
                        <label class="form-check-label" for="perm${perm.empPermissionTypeId}">
                            ${perm.empPermissionTypeName}
                        </label>
                    </div>
                `);
            });
        },
        error: function () {
            Swal.fire('錯誤', '權限資料讀取失敗，請稍後再試', 'error');
        }
    });
});

});
</script>
<script src="/js/empTobar.js"></script>
</body>
</html>
