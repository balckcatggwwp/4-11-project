<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<title>å“¡å·¥ç®¡ç†ç³»çµ± - å…‰å½±ä¹‹é–€</title>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet" />
<link
	href="https://cdn.datatables.net/2.2.2/css/dataTables.bootstrap5.min.css"
	rel="stylesheet" />
<link href="/css/sb-admin-2.min.css" rel="stylesheet" />
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
	rel="stylesheet" />
<link href="https://fonts.googleapis.com/css?family=Nunito"
	rel="stylesheet" />
</head>

<body id="page-top">
	<div id="wrapper">
		<!-- Sidebar -->
		<th:block th:replace="fragments/empSidebar :: sidebar"></th:block>

		<!-- Content -->
		<div id="content-wrapper" class="d-flex flex-column">
			<div id="content">
				<th:block th:replace="fragments/empTopbar :: topbar"></th:block>

				<div class="container-fluid">
					<div class="d-flex justify-content-between align-items-center mb-4">
						<h1 class="h4 mb-0 text-gray-800">å“¡å·¥ç®¡ç†ç³»çµ±</h1>
						<div class="btn-group">
							<button class="btn btn-success btn-sm" data-bs-toggle="modal"
								data-bs-target="#addEmployeeModal">
								<i class="fas fa-user-plus"></i> æ–°å¢å“¡å·¥
							</button>
							<button class="btn btn-outline-info btn-sm"
								id="batchAddEmployeeBtn">
								<i class="fas fa-robot me-1"></i> ä¸€éµæ–°å¢å‡å“¡å·¥
							</button>

						</div>
					</div>

					<div class="card shadow mb-4">
						<div class="card-body">
							<table id="employeeTable"
								class="table table-bordered table-striped">
								<thead class="table-light">
									<tr>
										<th>å§“å</th>
										<th>æ€§åˆ¥</th>
										<th>é›»è©±</th>
										<th>Email</th>
										<th>è·ç¨±</th>
										<th>æ“ä½œ</th>
									</tr>
								</thead>
							</table>
						</div>
					</div>
				</div>
			</div>
			<th:block th:replace="fragments/empFooter :: footer"></th:block>
		</div>

		<a class="scroll-to-top rounded" href="#page-top"><i
			class="fas fa-angle-up"></i></a>
	</div>
	<!-- æ–°å¢å“¡å·¥ Modalï¼ˆå·²å±•é–‹ï¼‰ -->
	<div class="modal fade" id="addEmployeeModal" tabindex="-1"
		aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">
						æ–°å¢å“¡å·¥
						<button type="button" class="btn btn-outline-info"
							id="autoFillEmpBtn">
							<i class="fas fa-magic me-1"></i> ä¸€éµå¡«å…¥
						</button>
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="é—œé–‰"></button>
				</div>
				<div class="modal-body">
					<form id="addEmployeeForm">
						<fieldset class="border p-3 mb-4 rounded">
							<legend class="w-auto px-2">åŸºæœ¬è³‡æ–™</legend>
							<div class="mb-3">
								<label class="form-label">å§“å</label> <input type="text"
									class="form-control" name="name" required />
							</div>
							<div class="mb-3">
								<label class="form-label">æ€§åˆ¥</label><br />
								<div class="form-check form-check-inline">
									<input class="form-check-input" type="radio" name="gender"
										value="male" required /> <label class="form-check-label">ç”·</label>
								</div>
								<div class="form-check form-check-inline">
									<input class="form-check-input" type="radio" name="gender"
										value="female" required /> <label class="form-check-label">å¥³</label>
								</div>
							</div>
							<div class="mb-3">
								<label class="form-label">èº«åˆ†è­‰å­—è™Ÿ</label> <input type="text"
									class="form-control" name="nationalId"
									pattern="[A-Z]{1}[12]{1}[0-9]{8}" required />
							</div>
							<div class="mb-3">
								<label class="form-label">ç”Ÿæ—¥</label> <input type="date"
									class="form-control" name="dateOfBirth" required />
							</div>
							<div class="mb-3">
								<label class="form-label">å…¥è·æ™‚é–“</label> <input type="date"
									class="form-control" name="entryTime" required />
							</div>
						</fieldset>

						<fieldset class="border p-3 mb-4 rounded">
							<legend class="w-auto px-2">å¸³è™Ÿè³‡è¨Š</legend>
							<div class="mb-3">
								<label class="form-label">Email</label> <input type="email"
									class="form-control" name="email" required />
							</div>
							<div class="mb-3">
								<label class="form-label">æ‰‹æ©Ÿè™Ÿç¢¼</label> <input type="text"
									class="form-control" name="phoneNumber" pattern="09[0-9]{8}"
									required />
							</div>
							<div class="row">
								<div class="col">
									<label class="form-label">å¯†ç¢¼</label> <input type="password"
										id="password" name="password" class="form-control" required />
								</div>
								<div class="col">
									<label class="form-label">ç¢ºèªå¯†ç¢¼</label> <input type="password"
										id="password2" class="form-control" required />
								</div>
							</div>
						</fieldset>

						<fieldset class="border p-3 mb-4 rounded">
							<legend class="w-auto px-2">è§’è‰²èˆ‡æ¬Šé™</legend>
							<div class="mb-3">
								<label class="form-label">é¸æ“‡è·ç¨±</label> <select
									class="form-select" id="jobTitleSelect"
									name="jobTitleCategoryId" required></select>
							</div>
							<div class="mb-3">
								<label class="form-label">æŒ‡æ´¾æ¬Šé™</label>
								<div id="permissionsCheckboxes" class="row"></div>
							</div>
						</fieldset>

						<div class="d-grid">
							<button type="submit" class="btn btn-primary">æ–°å¢å“¡å·¥</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="empDetailModal" tabindex="-1"
		aria-labelledby="empDetailModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">å“¡å·¥è©³ç´°è³‡æ–™</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="é—œé–‰"></button>
				</div>
				<div class="modal-body">
					<dl class="row">
						<dt class="col-sm-3">å§“å</dt>
						<dd class="col-sm-9" id="detail-name"></dd>
						<dt class="col-sm-3">æ€§åˆ¥</dt>
						<dd class="col-sm-9" id="detail-gender"></dd>
						<dt class="col-sm-3">é›»è©±</dt>
						<dd class="col-sm-9" id="detail-phone"></dd>
						<dt class="col-sm-3">Email</dt>
						<dd class="col-sm-9" id="detail-email"></dd>
						<dt class="col-sm-3">èº«åˆ†è­‰</dt>
						<dd class="col-sm-9" id="detail-nid"></dd>
						<dt class="col-sm-3">ç”Ÿæ—¥</dt>
						<dd class="col-sm-9" id="detail-dob"></dd>
						<dt class="col-sm-3">è·ç¨±</dt>
						<dd class="col-sm-9" id="detail-job"></dd>
						<dt class="col-sm-3">å…¥è·æ—¥</dt>
						<dd class="col-sm-9" id="detail-entry"></dd>
					</dl>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="empPermissionModal" tabindex="-1"
		aria-labelledby="empPermissionModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content border-0 shadow">
				<div class="modal-header bg-primary text-white">
					<h5 class="modal-title">
						<i class="fas fa-key me-2"></i>æ“æœ‰æ¬Šé™
					</h5>
					<button type="button" class="btn-close btn-close-white"
						data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
				</div>
				<div class="modal-body">
					<div class="overflow-auto" style="max-height: 300px;">
						<ul class="list-group list-group-flush" id="emp-permission-list">
							<!-- æ¬Šé™åˆ—è¡¨ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
						</ul>
					</div>
				</div>
				<div class="modal-footer bg-light">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">é—œé–‰</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="empEditModal" tabindex="-1"
		aria-labelledby="empEditModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">ç·¨è¼¯å“¡å·¥è³‡è¨Š</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<form id="empEditForm">
						<input type="hidden" id="edit-empId" name="empId" />

						<div class="mb-3">
							<label class="form-label">å§“å</label> <input type="text"
								class="form-control" id="edit-name" name="name" required />
						</div>

						<div class="mb-3">
							<label class="form-label">æ€§åˆ¥</label><br />
							<div class="form-check form-check-inline">
								<input class="form-check-input" type="radio" name="gender"
									id="edit-gender-male" value="male" /> <label
									class="form-check-label" for="edit-gender-male">ç”·</label>
							</div>
							<div class="form-check form-check-inline">
								<input class="form-check-input" type="radio" name="gender"
									id="edit-gender-female" value="female" /> <label
									class="form-check-label" for="edit-gender-female">å¥³</label>
							</div>
						</div>

						<div class="mb-3">
							<label class="form-label">èº«åˆ†è­‰å­—è™Ÿ</label> <input type="text"
								class="form-control" id="edit-nid" name="nationalId" required />
						</div>

						<div class="mb-3">
							<label class="form-label">ç”Ÿæ—¥</label> <input type="date"
								class="form-control" id="edit-dob" name="dateOfBirth" required />
						</div>

						<div class="mb-3">
							<label class="form-label">å…¥è·æ™‚é–“</label> <input type="date"
								class="form-control" id="edit-entry" name="entryTime" required />
						</div>

						<div class="mb-3">
							<label class="form-label">Email</label> <input type="email"
								class="form-control" id="edit-email" name="email" required />
						</div>

						<div class="mb-3">
							<label class="form-label">æ‰‹æ©Ÿè™Ÿç¢¼</label> <input type="text"
								class="form-control" id="edit-phone" name="phoneNumber" required />
						</div>

						<div class="mb-3">
							<label class="form-label">å¯†ç¢¼ï¼ˆå¦‚éœ€æ›´æ–°ï¼‰</label> <input type="password"
								class="form-control" id="edit-password" name="password" />
						</div>

						<div class="mb-3">
							<label class="form-label">è·ç¨±</label> <select class="form-select"
								id="edit-jobTitle" name="jobTitleCategoryId" required></select>
						</div>

						<div class="mb-3">
							<label class="form-label">æ¬Šé™</label>
							<div id="edit-permission-checkboxes" class="row"></div>
						</div>

						<div class="d-grid">
							<button type="submit" class="btn btn-success">å„²å­˜ä¿®æ”¹</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- JS -->
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
	<script
		src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="/js/sb-admin-2.min.js"></script>
	<script>
      $(document).ready(function () {
        const $employeeTable = $("#employeeTable").DataTable({
          ajax: {
            url: "/employeeApi/listLower",
            dataSrc: "",
          },
          columns: [
            { data: "name" },
            { data: "gender" },
            { data: "phoneNumber" },
            { data: "email" },
            { data: "jobTitleName" },
            {
              data: null,
              render: function (row) {
				  return `
				    <button class="btn btn-success btn-sm btn-view-emp" data-id="${row.empId}">
				      <i class="fas fa-id-card me-1"></i> è©³ç´°
				    </button>
				    <button class="btn btn-warning btn-sm btn-view-perm" data-id="${row.empId}">
				      <i class="fas fa-key me-1"></i> æ¬Šé™
				    </button>
				    <button class="btn btn-primary btn-sm btn-edit-emp" data-id="${row.empId}">
				      <i class="fas fa-pen-to-square me-1"></i> ç·¨è¼¯
				    </button>
				    <button class="btn btn-danger btn-sm btn-delete-emp" data-id="${row.empId}">
				      <i class="fas fa-trash me-1"></i> åˆªé™¤
				    </button>
				  `;
				}
            },
          ],
        });

        let currentUserLevel = 0;
        let currentUserPermissions = [];

        // å–å¾—ç›®å‰ç™»å…¥è€…çš„æ¬Šé™èˆ‡ç­‰ç´š
        $.get("/employeeApi/currentInfo", function (res) {
          if (res.error) {
            Swal.fire("éŒ¯èª¤", "å°šæœªç™»å…¥æˆ–å–å¾—è·ä½è³‡è¨Šå¤±æ•—", "error");
            return;
          }
          currentUserLevel = res.jobLevel;
          currentUserPermissions = res.permissionIds;

          // è¼‰å…¥è·ç¨±ï¼ˆæ¯”è‡ªå·±ä½ï¼‰
          $.get("/jobTitleApi/list", function (titles) {
            const $select = $("#jobTitleSelect");
            $select.empty();
            titles.forEach((title) => {
              if (title.jobLevel < currentUserLevel) {
                $select.append(
                  `<option value="${title.jobTitleCategoryId}" data-level="${title.jobLevel}">
                ${title.jobTitleName}
              </option>`
                );
              }
            });
          });

          // è¼‰å…¥æ¬Šé™ï¼ˆè‡ªå·±æ“æœ‰çš„ï¼‰
          $.get("/empPermissionApi/list", function (perms) {
            const $container = $("#permissionsCheckboxes").empty();
            perms.forEach((p) => {
              if (currentUserPermissions.includes(p.empPermissionTypeId)) {
                $container.append(`
              <div class="col-md-4 mb-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="permissions" value="${p.empPermissionTypeId}" id="perm${p.empPermissionTypeId}">
                  <label class="form-check-label" for="perm${p.empPermissionTypeId}">${p.empPermissionTypeName}</label>
                </div>
              </div>`);
              }
            });
          });
        });

        // æ–°å¢å“¡å·¥è¡¨å–®é€å‡º
        $("#addEmployeeForm").on("submit", function (e) {
          e.preventDefault();
          const pwd1 = $("#password").val();
          const pwd2 = $("#password2").val();

          if (pwd1 !== pwd2) {
            Swal.fire("éŒ¯èª¤", "å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´", "error");
            return;
          }

          const selectedJobLevel = $("#jobTitleSelect option:selected").data(
            "level"
          );
          if (selectedJobLevel >= currentUserLevel) {
            Swal.fire("éŒ¯èª¤", "åªèƒ½é¸æ“‡æ¯”ä½ è·ç­‰ä½çš„è·ç¨±", "error");
            return;
          }

          const selectedPerms = $('input[name="permissions"]:checked')
            .map((_, el) => parseInt($(el).val()))
            .get();
          const invalid = selectedPerms.find(
            (p) => !currentUserPermissions.includes(p)
          );
          if (invalid) {
            Swal.fire("éŒ¯èª¤", "åªèƒ½æŒ‡æ´¾ä½ æ“æœ‰çš„æ¬Šé™", "error");
            return;
          }

          const formData = {
            name: $('input[name="name"]').val(),
            gender: $('input[name="gender"]:checked').val(),
            nationalId: $('input[name="nationalId"]').val(),
            dateOfBirth: $('input[name="dateOfBirth"]').val(),
            entryTime: $('input[name="entryTime"]').val(),
            email: $('input[name="email"]').val(),
            phoneNumber: $('input[name="phoneNumber"]').val(),
            password: pwd1,
            jobTitleCategoryId: $("#jobTitleSelect").val(),
            permissionIds: selectedPerms,
          };

          $.ajax({
            url: "/employeeApi/add",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(formData),
            success: function (res) {
              if (res.status === "success") {
                Swal.fire("æˆåŠŸ", "å“¡å·¥å·²æ–°å¢", "success").then(() => {
                  $("#addEmployeeModal").modal("hide");
                  location.reload();
                });
              } else {
                Swal.fire("éŒ¯èª¤", res.message || "æ–°å¢å¤±æ•—", "error");
              }
            },
            error: function () {
              Swal.fire("éŒ¯èª¤", "ä¼ºæœå™¨ç„¡å›æ‡‰æˆ–é€£ç·šéŒ¯èª¤", "error");
            },
          });
        });

        // è©³ç´°è³‡æ–™
        $("#employeeTable tbody").on("click", ".btn-view-emp", function () {
          const empId = $(this).data("id");
          $.get(`/employeeApi/detail/${empId}`, function (emp) {
            $("#detail-name").text(emp.name);
            $("#detail-gender").text(emp.gender === "male" ? "ç”·" : "å¥³");
            $("#detail-phone").text(emp.phoneNumber);
            $("#detail-email").text(emp.email);
            $("#detail-nid").text(emp.nationalId);
            $("#detail-dob").text(emp.dateOfBirth);
            $("#detail-job").text(emp.jobTitleName);
            $("#detail-entry").text(emp.entryTime);
            $("#empDetailModal").modal("show");
          }).fail(() => Swal.fire("éŒ¯èª¤", "ç„¡æ³•å–å¾—å“¡å·¥è³‡æ–™", "error"));
        });

        // æŸ¥çœ‹æ¬Šé™
        $("#employeeTable tbody").on("click", ".btn-view-perm", function () {
          const empId = $(this).data("id");
          const $list = $("#emp-permission-list").empty();

          $.get(`/employeeApi/permissions/${empId}`, function (perms) {
            if (perms.length === 0) {
              $list.append(`
				  <li class="list-group-item text-center text-muted">
				    <i class="fas fa-exclamation-circle me-2"></i>å°šæœªæŒ‡æ´¾ä»»ä½•æ¬Šé™
				  </li>
				`);
            } else {
              perms.forEach((p) =>
                $list.append(`<li class="list-group-item">${p}</li>`)
              );
            }
            $("#empPermissionModal").modal("show");
          }).fail(() => Swal.fire("éŒ¯èª¤", "ç„¡æ³•å–å¾—æ¬Šé™è³‡æ–™", "error"));
        });

        // ç·¨è¼¯å“¡å·¥
        $("#employeeTable tbody").on("click", ".btn-edit-emp", function () {
          const empId = $(this).data("id");
          $("#edit-empId").val(empId);

          // æ¸…ç©ºæ¬„ä½
          $("#empEditForm")[0].reset();
          $("#edit-jobTitle").empty();
          $("#edit-permission-checkboxes").empty();

          $.get(`/employeeApi/detail/${empId}`, function (emp) {
            $("#edit-name").val(emp.name);
            $(`#edit-gender-${emp.gender}`).prop("checked", true);
            $("#edit-nid").val(emp.nationalId);
            $("#edit-dob").val(emp.dateOfBirth);
            $("#edit-entry").val(emp.entryTime);
            $("#edit-email").val(emp.email);
            $("#edit-phone").val(emp.phoneNumber);

            // è¼‰å…¥è·ç¨±
            $.get("/jobTitleApi/list", function (list) {
              list.forEach((t) => {
                const selected =
                  t.jobTitleCategoryId === emp.jobTitleCategoryId
                    ? "selected"
                    : "";
                $("#edit-jobTitle").append(
                  `<option value="${t.jobTitleCategoryId}" ${selected}>${t.jobTitleName}</option>`
                );
              });
            });

            // è¼‰å…¥æ¬Šé™
            $.get("/empPermissionApi/list", function (allPerms) {
              const $box = $("#edit-permission-checkboxes").empty();
              allPerms.forEach((p) => {
                const checked = emp.permissions?.includes(
                  p.empPermissionTypeName
                )
                  ? "checked"
                  : "";
                $box.append(`
              <div class="col-md-4 mb-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="permissions"
                    value="${p.empPermissionTypeId}" id="editPerm${p.empPermissionTypeId}" ${checked}>
                  <label class="form-check-label" for="editPerm${p.empPermissionTypeId}">
                    ${p.empPermissionTypeName}
                  </label>
                </div>
              </div>`);
              });
              $("#empEditModal").modal("show");
            });
          }).fail(() => Swal.fire("éŒ¯èª¤", "ç„¡æ³•è¼‰å…¥å“¡å·¥è³‡æ–™", "error"));
        });

        // ç·¨è¼¯è¡¨å–®é€å‡º
        $("#empEditForm").on("submit", function (e) {
          e.preventDefault();

          const formData = {
            empId: $("#edit-empId").val(),
            name: $("#edit-name").val(),
            gender: $("input[name='gender']:checked").val(),
            nationalId: $("#edit-nid").val(),
            dateOfBirth: $("#edit-dob").val(),
            entryTime: $("#edit-entry").val(),
            email: $("#edit-email").val(),
            phoneNumber: $("#edit-phone").val(),
            password: $("#edit-password").val(), // å¯ç‚ºç©º
            jobTitleCategoryId: $("#edit-jobTitle").val(),
            permissionIds: $("input[name='permissions']:checked")
              .map((_, el) => $(el).val())
              .get(),
          };

          $.ajax({
            url: "/employeeApi/update",
            method: "PUT",
            data: formData,
            success: function (res) {
              if (res.status === "success") {
                Swal.fire("æˆåŠŸ", "å“¡å·¥è³‡æ–™å·²æ›´æ–°", "success").then(() => {
                  $("#empEditModal").modal("hide");
                  $employeeTable.ajax.reload();
                });
              } else {
                Swal.fire("éŒ¯èª¤", res.message || "æ›´æ–°å¤±æ•—", "error");
              }
            },
            error: function () {
              Swal.fire("éŒ¯èª¤", "ä¼ºæœå™¨é€£ç·šå¤±æ•—", "error");
            },
          });
        });

        // åˆªé™¤å“¡å·¥
        $("#employeeTable tbody").on("click", ".btn-delete-emp", function () {
          const empId = $(this).data("id");
          Swal.fire({
            title: "ç¢ºå®šè¦åˆªé™¤é€™ä½å“¡å·¥å—ï¼Ÿ",
            text: "åˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸ",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "æ˜¯çš„ï¼Œåˆªé™¤",
            cancelButtonText: "å–æ¶ˆ",
          }).then((result) => {
            if (result.isConfirmed) {
              $.ajax({
                url: `/employeeApi/delete/${empId}`,
                method: "DELETE",
                success: function () {
                  Swal.fire("å·²åˆªé™¤", "è©²å“¡å·¥å·²æˆåŠŸç§»é™¤", "success");
                  $employeeTable.ajax.reload();
                },
                error: function () {
                  Swal.fire("éŒ¯èª¤", "åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
                },
              });
            }
          });
        });
      });
      
     async function generateFakeEmployee(index) {
	  const name = `æ¸¬è©¦å“¡å·¥${index}`;
	  const gender = Math.random() < 0.5 ? 'male' : 'female';
	  const nationalId = generateFakeNationalId();
	  const dateOfBirth = randomDate(1980, 2000);
	  const entryTime = randomDate(2010, 2024);
	  const password = '1111';
	
	  let email, phone;
	  let tries = 0;
	  do {
	    email = `test_emp${Date.now()}_${index}@demo.com`;
	    phone = `09${Math.floor(10000000 + Math.random() * 89999999)}`;
	    const checkRes = await $.ajax({
	      url: '/employee/empRegister',
	      type: 'POST',
	      data: { email, phoneNumber: phone },
	      error: () => ({ status: 'error' })
	    });
	    if (checkRes.status === 'error') {
	      tries++;
	    } else {
	      break;
	    }
	  } while (tries < 5);
	
	  return {
	    name, gender, nationalId, dateOfBirth, entryTime,
	    email, phoneNumber: phone, password
	  };
	}
	
	function randomDate(startYear, endYear) {
	  const start = new Date(`${startYear}-01-01`).getTime();
	  const end = new Date(`${endYear}-12-31`).getTime();
	  return new Date(start + Math.random() * (end - start)).toISOString().split('T')[0];
	}
	
	function generateFakeNationalId() {
	  const first = String.fromCharCode(65 + Math.floor(Math.random() * 26));
	  const second = Math.random() < 0.5 ? '1' : '2';
	  const nums = String(Math.floor(10000000 + Math.random() * 89999999));
	  return first + second + nums;
	}
	
	// ğŸ‘‡ ç¶å®šæŒ‰éˆ•ç”¨ï¼ˆå»ºè­°æ”¾åœ¨ modal é–‹å®Œè·ç¨±æ¬Šé™éƒ½è¼‰å…¥å¾Œï¼‰
	$('#batchAddEmployeeBtn').click(async function () {
	  const jobTitleId = $('#jobTitleSelect option:eq(1)').val();
	  const permissionIds = $('#permissionsCheckboxes input:checked')
	    .map((_, el) => parseInt($(el).val())).get();
	
	  const promises = [];
	  for (let i = 1; i <= 5; i++) {
	    const emp = await generateFakeEmployee(i);
	    emp.jobTitleCategoryId = jobTitleId;
	    emp.permissionIds = permissionIds;
	
	    promises.push($.ajax({
	      url: '/employeeApi/add',
	      method: 'POST',
	      contentType: 'application/json',
	      data: JSON.stringify(emp)
	    }));
	  }
	
	  Promise.all(promises).then(() => {
	    Swal.fire('å®Œæˆ', 'å·²æˆåŠŸæ–°å¢ 5 ä½å“¡å·¥', 'success');
	    $('#employeeTable').DataTable().ajax.reload();
	  }).catch(() => {
	    Swal.fire('éŒ¯èª¤', 'æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ ¼å¼èˆ‡æ¬Šé™', 'error');
	  });
	});
    </script>
	<script>
    function generateFakeNationalId() {
		  const first = String.fromCharCode(65 + Math.floor(Math.random() * 26));
		  const second = Math.random() < 0.5 ? '1' : '2';
		  const numbers = Math.floor(10000000 + Math.random() * 89999999).toString();
		  return first + second + numbers;
		}
		
		function generateRandomDate(startYear, endYear) {
		  const start = new Date(`${startYear}-01-01`).getTime();
		  const end = new Date(`${endYear}-12-31`).getTime();
		  return new Date(start + Math.random() * (end - start)).toISOString().split('T')[0];
		}
		
		async function getUniqueEmailAndPhone() {
		  let tryCount = 0;
		  while (tryCount < 5) {
		    const email = `emp${Date.now()}${tryCount}@demo.com`;
		    const phone = '09' + Math.floor(10000000 + Math.random() * 89999999);
		    
		    const check = await $.ajax({
		      url: '/employee/empRegister',
		      type: 'POST',
		      data: { email, phoneNumber: phone },
		      error: () => ({ status: 'error' })
		    });
		
		    if (check.status !== 'error') {
		      return { email, phone };
		    }
		    tryCount++;
		  }
		  throw new Error('ç„¡æ³•ç”¢ç”Ÿå”¯ä¸€çš„ email / æ‰‹æ©Ÿè™Ÿç¢¼');
		}
		
		$('#autoFillEmpBtn').click(async function () {
		  try {
		    const today = new Date().toISOString().split('T')[0];
		    const gender = Math.random() < 0.5 ? 'male' : 'female';
		    const { email, phone } = await getUniqueEmailAndPhone();
		
		    $('input[name="name"]').val('æ¸¬è©¦å“¡å·¥');
		    $(`input[name="gender"][value="${gender}"]`).prop('checked', true);
		    $('input[name="nationalId"]').val(generateFakeNationalId());
		    $('input[name="dateOfBirth"]').val(generateRandomDate(1980, 2000));
		    $('input[name="entryTime"]').val(today);
		    $('input[name="email"]').val(email);
		    $('input[name="phoneNumber"]').val(phone);
		    $('#password').val('1111');
		    $('#password2').val('1111');
		
		    // é è¨­é¸æ“‡ç¬¬ä¸€å€‹æœ‰æ•ˆè·ç¨±
		    const firstJobTitle = $('#jobTitleSelect option:eq(1)').val();
		    $('#jobTitleSelect').val(firstJobTitle);
		
		    // é è¨­å‹¾é¸æ‰€æœ‰æ¬Šé™ï¼ˆä½ å¯è¦–éœ€è¦èª¿æ•´ï¼‰
		    $('#permissionsCheckboxes input[type="checkbox"]').prop('checked', true);
		  } catch (err) {
		    Swal.fire('éŒ¯èª¤', err.message || 'ç”¢ç”Ÿæ¸¬è©¦è³‡æ–™å¤±æ•—', 'error');
		  }
		});
    
    </script>
	<script src="/js/empTobar.js"></script>
	<script src="/js/empLogout.js"></script>
	<script src="/js/checkEmpSession.js"></script>
</body>
</html>
